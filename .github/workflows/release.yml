name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  ONNX_VERSION: "1.20.0"
  GO_VERSION: "1.21"

jobs:
  # ── Windows (amd64) ───────────────────────────────────────────
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download ONNX Runtime (Windows x64)
        shell: pwsh
        run: |
          $url = "https://github.com/microsoft/onnxruntime/releases/download/v$env:ONNX_VERSION/onnxruntime-win-x64-$env:ONNX_VERSION.zip"
          Invoke-WebRequest -Uri $url -OutFile onnxruntime.zip
          Expand-Archive onnxruntime.zip -DestinationPath onnxruntime

      - name: Build Windows binary
        shell: pwsh
        env:
          CGO_ENABLED: "1"
        run: |
          $base = "${{ github.workspace }}\onnxruntime\onnxruntime-win-x64-$env:ONNX_VERSION"
          $env:CGO_CFLAGS  = "-I$base\include"
          $env:CGO_LDFLAGS = "-L$base\lib"
          New-Item -ItemType Directory -Force -Path dist\bin | Out-Null
          go build -ldflags="-s -w" -o dist\bin\friday.exe .\cmd\cli

      - name: Stage artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path stage | Out-Null
          Copy-Item dist\bin\friday.exe stage\
          Copy-Item "onnxruntime\onnxruntime-win-x64-$env:ONNX_VERSION\lib\onnxruntime.dll" stage\

      - uses: actions/upload-artifact@v4
        with:
          name: friday-windows
          path: stage/

  # ── Linux (amd64) ─────────────────────────────────────────────
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download ONNX Runtime (Linux x64)
        run: |
          wget -q https://github.com/microsoft/onnxruntime/releases/download/v${ONNX_VERSION}/onnxruntime-linux-x64-${ONNX_VERSION}.tgz
          tar -xzf onnxruntime-linux-x64-${ONNX_VERSION}.tgz

      - name: Build Linux binary
        env:
          CGO_ENABLED: "1"
        run: |
          BASE="${{ github.workspace }}/onnxruntime-linux-x64-${ONNX_VERSION}"
          export CGO_CFLAGS="-I${BASE}/include"
          export CGO_LDFLAGS="-L${BASE}/lib"
          mkdir -p dist/bin
          go build -ldflags="-s -w" -o dist/bin/friday-linux-amd64 ./cmd/cli

      - name: Stage artifacts
        run: |
          mkdir -p stage
          cp dist/bin/friday-linux-amd64 stage/
          cp onnxruntime-linux-x64-${ONNX_VERSION}/lib/libonnxruntime.so.${ONNX_VERSION} stage/libonnxruntime.so

      - uses: actions/upload-artifact@v4
        with:
          name: friday-linux
          path: stage/

  # ── macOS Intel (amd64) ───────────────────────────────────────
  build-macos-amd64:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download ONNX Runtime (macOS x86_64)
        run: |
          wget -q https://github.com/microsoft/onnxruntime/releases/download/v${ONNX_VERSION}/onnxruntime-osx-x86_64-${ONNX_VERSION}.tgz
          tar -xzf onnxruntime-osx-x86_64-${ONNX_VERSION}.tgz

      - name: Build macOS Intel binary
        env:
          CGO_ENABLED: "1"
        run: |
          BASE="${{ github.workspace }}/onnxruntime-osx-x86_64-${ONNX_VERSION}"
          export CGO_CFLAGS="-I${BASE}/include"
          export CGO_LDFLAGS="-L${BASE}/lib"
          mkdir -p dist/bin
          go build -ldflags="-s -w" -o dist/bin/friday-darwin-amd64 ./cmd/cli

      - name: Stage artifacts
        run: |
          mkdir -p stage
          cp dist/bin/friday-darwin-amd64 stage/
          cp onnxruntime-osx-x86_64-${ONNX_VERSION}/lib/libonnxruntime.${ONNX_VERSION}.dylib stage/libonnxruntime-amd64.dylib

      - uses: actions/upload-artifact@v4
        with:
          name: friday-macos-amd64
          path: stage/

  # ── macOS Apple Silicon (arm64) ───────────────────────────────
  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download ONNX Runtime (macOS arm64)
        run: |
          wget -q https://github.com/microsoft/onnxruntime/releases/download/v${ONNX_VERSION}/onnxruntime-osx-arm64-${ONNX_VERSION}.tgz
          tar -xzf onnxruntime-osx-arm64-${ONNX_VERSION}.tgz

      - name: Build macOS ARM binary
        env:
          CGO_ENABLED: "1"
        run: |
          BASE="${{ github.workspace }}/onnxruntime-osx-arm64-${ONNX_VERSION}"
          export CGO_CFLAGS="-I${BASE}/include"
          export CGO_LDFLAGS="-L${BASE}/lib"
          mkdir -p dist/bin
          go build -ldflags="-s -w" -o dist/bin/friday-darwin-arm64 ./cmd/cli

      - name: Stage artifacts
        run: |
          mkdir -p stage
          cp dist/bin/friday-darwin-arm64 stage/
          cp onnxruntime-osx-arm64-${ONNX_VERSION}/lib/libonnxruntime.${ONNX_VERSION}.dylib stage/libonnxruntime-arm64.dylib

      - uses: actions/upload-artifact@v4
        with:
          name: friday-macos-arm64
          path: stage/

  # ── Assemble installer and publish release ────────────────────
  release:
    needs: [build-windows, build-linux, build-macos-amd64, build-macos-arm64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Assemble installer package
        run: |
          mkdir -p friday-installer/bin

          # Installer config files (stored in repo under .github/installer/)
          cp .github/installer/docker-compose.yml friday-installer/
          cp .github/installer/config.yaml        friday-installer/
          cp .github/installer/install.sh         friday-installer/
          cp .github/installer/install.ps1        friday-installer/

          # Fix line endings on install.sh (safety measure)
          sed -i 's/\r//' friday-installer/install.sh
          chmod +x friday-installer/install.sh

          # Windows binary + DLL (DLL must be in same folder as .exe)
          cp artifacts/friday-windows/friday.exe       friday-installer/bin/
          cp artifacts/friday-windows/onnxruntime.dll  friday-installer/bin/

          # Linux binary + shared library
          cp artifacts/friday-linux/friday-linux-amd64  friday-installer/bin/
          cp artifacts/friday-linux/libonnxruntime.so   friday-installer/bin/
          chmod +x friday-installer/bin/friday-linux-amd64

          # macOS binaries + dylibs (separate per arch, install.sh selects correct one)
          cp artifacts/friday-macos-amd64/friday-darwin-amd64        friday-installer/bin/
          cp artifacts/friday-macos-amd64/libonnxruntime-amd64.dylib friday-installer/bin/
          cp artifacts/friday-macos-arm64/friday-darwin-arm64        friday-installer/bin/
          cp artifacts/friday-macos-arm64/libonnxruntime-arm64.dylib friday-installer/bin/
          chmod +x friday-installer/bin/friday-darwin-amd64
          chmod +x friday-installer/bin/friday-darwin-arm64

          # Create zip
          zip -r friday-installer-${{ github.ref_name }}.zip friday-installer/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: friday-installer-${{ github.ref_name }}.zip
          generate_release_notes: true
